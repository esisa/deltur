<!DOCTYPE html>
<!-- saved from url=(0063)http://twitter.github.com/bootstrap/examples/sticky-footer.html -->
<html lang="en">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta charset="utf-8">
    <title>deltur.no</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="">
    

    <script type=text/javascript>
  	     $SCRIPT_ROOT = {{ request.script_root|tojson|safe }};
    </script>
    
    <script src="http://code.jquery.com/jquery-1.9.1.js"></script>
    <script src="{{ url_for('static', filename='js/lib/proj4s/proj4js-combined.js') }}"></script>
	<script src="http://cdn.leafletjs.com/leaflet-0.7.1/leaflet.js"></script>
    <script src="{{ url_for('static', filename='js/lib/leaflet.awesome-markers.min.js') }}"></script>   


    <link rel="stylesheet" href="{{ url_for('static', filename='css/leaflet.awesome-markers.css') }}">
	<link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7.1/leaflet.css" />
    <link rel="stylesheet" href="http://bootswatch.com/slate/bootstrap.min.css">
	<link rel="stylesheet" href="{{ url_for('static', filename='fontawesome/css/font-awesome.css') }}">
    <style type="text/css">

          html,
          body {
            height: 100%;
            /* The html and body elements cannot have any padding or margin. */
          }

    </style>
				
    	
    	
    
    <script type="text/javascript">
        var _gaq = _gaq || [];
        _gaq.push(['_setAccount', 'UA-40003995-1']);
        _gaq.push(['_trackPageview']);

        (function () {
            var ga = document.createElement('script');
            ga.type = 'text/javascript';
            ga.async = true;
            ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(ga, s);
        })();
    </script>					   

</head>

<body>
      		
    <div id="map" style="height: 100%; ">
        <a id="cartodb_logo" style="position:absolute; bottom:4px; left:4px; display:block; z-index:10000;" href="http://deltur.no" target="_blank">
        <img title="deltur.no" width="50" alt="deltur.no" style="outline: medium none; border: medium none;" src="{{ url_for('static', filename='img/map_logo.png') }}">
        </a>
    </div>


    <script type="text/javascript">

        $.fn.preload = function() {
            this.each(function(){
                $('<img/>')[0].src = this;
            });
        }

    	var map = new L.Map('map', {keyboard: true, attributionControl: true});

    	map.attributionControl.setPrefix(""); // Fjerner powered by Leaflet
    

    	skikart = new L.TileLayer("http://kart{s}.turkompisen.no/cgi-bin/tilecache.cgi/1.0.0/skikart/{z}/{x}/{y}.png", {
    		attribution: '© <a href="http://www.openstreetmap.org" target="_new">OpenStreetMap</a>-bidragsytere, <a href="http://creativecommons.org/licenses/by-sa/2.0/" target="_new">CC-BY-SA</a> og <a href="http://www.skogoglandskap.no" target="_new">Skog og Landskap</a>', 
    		subdomains: ["1", "2", "3", "4"],
    		//scheme: "tms",
    		maxZoom: 18
    	});

    	turkart = new L.TileLayer("http://kart{s}.turkompisen.no/cgi-bin/tilecache.cgi/1.0.0/turkart/{z}/{x}/{y}.png", {
    		attribution: '© <a href="http://www.openstreetmap.org" target="_new">OpenStreetMap</a>-bidragsytere, <a href="http://creativecommons.org/licenses/by-sa/2.0/" target="_new">CC-BY-SA</a> og <a href="http://www.skogoglandskap.no" target="_new">Skog og Landskap</a>', 
    		subdomains: ["1", "2", "3", "4"],
    		//scheme: "tms",
    		maxZoom: 18
    	});
    	
    	veikart = new L.TileLayer("http://api.tiles.mapbox.com/v3/esisa.map-0tz2sd3q/{z}/{x}/{y}.png", {
    		attribution: '© <a href="http://www.openstreetmap.org" target="_new">OpenStreetMap</a>-bidragsytere, <a href="http://creativecommons.org/licenses/by-sa/2.0/" target="_new">CC-BY-SA</a>', 
    		subdomains: ["1", "2", "3", "4"],
    		//scheme: "tms",
    		maxZoom: 18
    	});
        
    	topokart = new L.TileLayer("http://opencache.statkart.no/gatekeeper/gk/gk.open_gmaps?layers=norges_grunnkart&zoom={z}&x={x}&y={y}", {
    		attribution: '<a target="_new" href="http://www.kartverket.no">Statens kartverk</a>, <a target="_new" href="http://www.statkart.no/nor/Land/Fagomrader/Geovekst/">Geovekst</a> og <a target="_new" href="http://www.statkart.no/?module=Articles;action=Article.publicShow;ID=14194">kommuner</a>', 
    		subdomains: ["1", "2", "3", "4"],
    		//scheme: "tms",
    		maxZoom: 18
    	});

        if({{mapType}}==0) {
            map.addLayer(turkart);
        }
        else if({{mapType}}==1) {
            map.addLayer(skikart);
        }
        else if({{mapType}}==2) {
            map.addLayer(veikart);
        }
        else if({{mapType}}==3) {
            map.addLayer(topokart);
        }
    	    

        var idLists = {{idList}};
        var ids = "{{idList}}".split("+");
        
    	var myStyle = {
            "color": "#ff7800",
            "weight": 5,
            "opacity": 0.65
        };

        var geoObject;
        var markerGroup = new L.LayerGroup();
        var numLines = 0;
        var lineFeature;
        var trip = L.geoJson();
        trip.addTo(map);
        var featureBounds = new L.LatLngBounds();

        $.each(ids, function (index, value) {
            var id = value;


            $.getJSON('/' + id + '/geojson', function (data) {
                geoObject = [data];

                var line = true;
                if (data.type == "Point") {
                    line = false;
                }

                map.addLayer(markerGroup);
                var marker;
                if (line) {
                    numLines++;
                    lineFeature = geoObject;

                    trip.addData(geoObject[0]);

                    featureBounds.extend(trip.getBounds());



                    var start = L.AwesomeMarkers.icon({
                        prefix: 'fa',
                        icon: 'play',
                        markerColor: 'green'
                    });

                    var stop = L.AwesomeMarkers.icon({
                        prefix: 'fa',
                        icon: 'stop',
                        markerColor: 'red'
                    });


                    var marker = L.marker([lineFeature[0].coordinates[lineFeature[0].coordinates.length - 1][1], lineFeature[0].coordinates[lineFeature[0].coordinates.length - 1][0]], {
                        icon: stop
                    });
                    marker.addTo(map).bindPopup('Slutt');

                    // Set start and stop marker
                    var marker = L.marker([lineFeature[0].coordinates[0][1], lineFeature[0].coordinates[0][0]], {
                        icon: start
                    });
                    marker.addTo(map).bindPopup('Start');

                } else {

                    var picture = L.AwesomeMarkers.icon({
                        prefix: 'fa',
                        icon: 'picture-o',
                        markerColor: 'blue'
                    });
                    $.getJSON('/' + id + '/metadata', function (metadata) {
                        var marker = L.marker([data.coordinates[1], data.coordinates[0]], {
                            icon: picture
                        });
                        marker.addTo(map).bindPopup('<h3 id="popupText">' + metadata.title + '</h3><img width="250" src="' + metadata.url + '"><br><div id="popupText">' + metadata.description + '</div>');
                        $([metadata.url]).preload(); // Preload image
                        featureBounds.extend(marker.getLatLng());
                    });

                }

                trip.setStyle(myStyle);



                // TODO: Rewrite
                setTimeout(function () {
                    map.fitBounds(featureBounds);
                    setTimeout(function () {
                        if (numLines == 0 && map.getZoom() > 11) {
                            map.setZoom(11);
                        }


                    }, 300);
                }, 300);



            });

        });
        

    </script>

</html>
